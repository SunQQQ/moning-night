<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>发动态</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link href="css/base.css" rel="stylesheet" type="text/css">
    <link href="css/iconfont.css" rel="stylesheet" type="text/css">
    <link href="css/circle_add.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="topbar">
    <a class="left" href="circle.html">
        <i class="iconfont">&#xe620;</i>
    </a>
    <div class="center">发动态</div>
    <div class="right">
        发表
    </div>
</div>
<div class="menu_hold"></div>
<div class="addArea">
    <textarea placeholder="说点什么吧..." id="addText" value="txt" name="txtInput"></textarea>
    <div class="selectPics">
        <div class="pics_button">
            <div class="camara">
                <i class="iconfont icon_camara">&#xe60e;</i>
            </div>
            <div class="hint">照片</div>
            <input type="file" class="picInput" onchange="imageUpload(this)" multiple="multiple">
        </div>
    </div>
</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script>
    var selectPics = document.getElementsByClassName("selectPics")[0];
    var imgArray = [];


    document.getElementsByClassName("right")[0].onclick = function () {
        var picData = new FormData();
        imgArray = JSON.stringify(imgArray);
        picData.append('picInput',imgArray);
        picData.append('txtInput',document.getElementById("addText").value);

        $.ajax(
            {
                url:"http://localhost/proxy/sunq/moningNight/app/addshuoshuo.php",
                type:"POST",
                processData: false,
                contentType:false,
                data:picData,
                datatype:"json",
                success:function (ret) {
                    console.log("ajax成功");
                    console.log(JSON.parse(ret));
                }
            }
        );
    }

    function imageUpload(file) {
        var arrayIndex = 0;
        for(var i=0,f;f=file.files[i];i++){
            var fileRader = new FileReader();
            fileRader.readAsDataURL(f);
            fileRader.onload = function (event) {
                drawPic(event.target.result,arrayIndex,imgArray);
                imgArray.push(event.target.result);
                arrayIndex++;
            }
        }
    }
    function drawPic(url,arrayIndex,imgArray) {
        /*动态生成div*/
        var createImgDiv = document.createElement("div");
        createImgDiv.className = "createImgDiv";
        createImgDiv.id = "createImgDiv" + arrayIndex;
        /*动态生成img*/
        var imageElement = document.createElement("img");
        imageElement.src = url;
        /*动态生成取消按钮*/
        var cancelButton = document.createElement("div");
        cancelButton.className = "cancelButton";
        cancelButton.id = "cancelButton" + arrayIndex;


        /*img放在div中*/
        createImgDiv.append(imageElement);
        createImgDiv.append(cancelButton);

        /*放着图片的div放在指定位置*/
        selectPics.prepend(createImgDiv);
//        console.log(arrayIndex);

        console.log(arrayIndex);
        document.getElementById("cancelButton"+arrayIndex).onclick = function () {
            document.getElementById("createImgDiv"+arrayIndex).style.display = "none";
            imgArray.splice(arrayIndex,1);
            console.log(imgArray);
        };
        /*循环中index会只取最终值
        document.getElementsByClassName("cancelButton")[arrayIndex].onclick = function () {
            console.log("j");
        };*/
    }
</script>
</body>
</html>